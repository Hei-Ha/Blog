## 浏览器从输入 URL 到页面显示，发什么了什么？

大致流程如下：

1. 浏览器解析 URL
2. DNS 解析，获取真实 IP 地址
3. 建立 TCP 连接。
4. 发送 HTTP/ HTTPS 请求。
5. 服务器响应请求。
6. 浏览器解析数据，并且渲染页面。

7. HTTP/HTTPS 请求结束，断开连接。

**详细解析：**

1. 输入 url 后，浏览器会对输入的内容进行检测，看其是否符合 URL 规范，如果符合，则看是否完整，不完整的话，会根据一些规则去猜测、补全；如果不符合 URL 规范，则用搜索引擎去搜索输入的内容。

2. DNS 解析是为了拿到真实的 IP 地址，大致是这么一个顺序：

   1. 浏览器先查找自己的缓存，看是否缓存过当前域名的 IP 。
   2. 再询问操作系统，看操作系统是否记录。
   3. 再在 hosts 文件中是否能找到。
   4. 再问本地 DNS 服务器。
      1. 本地 DNS 服务器如果没有，则会向根域名服务器发送查询，根域名服务器返回顶级域名服务器地址
      2. 本地DNS 服务器再向顶级域名服务器发送查询，顶级域名服务器返回权威 DNS 服务器地址。
      3. 本地 DNS 服务器再向权威 DNS 服务器发送查询，权威 DNS 服务器返回查到的 IP 地址。

3. TCP 连接

   当浏览器获取到真实 IP 地址后，浏览器会用一个随机的端口，向服务器发起 TCP 连接请求，连接请求到达服务端后，通过三次握手，建立TCP 的连接

4. 发送 HTTP 请求数据，

   简历连接后，就可以通过 HTTP 进行数据传输，如果是 HTTPS，在发送数据之前还会使用 SSL/TLS，进行加密服务认证，保证数据安全。

5. 服务器响应

   服务器根据请求返回相应的资源。

6. 浏览器解析数据

   1. 处理 HTML 标记并构建 DOM 树。
   2. 处理 CSS 标记并构建 CSSOM 树。
   3. 将 DOM 与 CSSOM 合并成一个渲染树。
   4. 根据渲染树来布局，以计算每个节点的几何信息。
   5. 将各个节点绘制到屏幕上。

7. 四次挥手，断开连接

   页面为了优化请求耗时，默认都会开启持久连接 keep-alive，那么一个 TCP 连接确切关闭的时机，是这个 tab 标签页关闭的时候。这个关闭的过程就是四次挥手。
   
   1. 主动关闭方发送一个 FIN，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不会再给你发数据了（在 FIN 包之前发送出去的数据，如果没有收到对应的 ACK 确认报文，主动关闭方依然会重发这些数据），但此时主动关闭方还可以接受数据
   2. 被动关闭方收到 FIN 包后，发送一个 ACK 给对方，确认序号为收到序号+1（与 SYN 相同，一个 FIN 占用一个序号）。
   3. 被动关闭方发送一个 FIN，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。
   4. 主动关闭方收到 FIN 后，发送一个 ACK 给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。



![四次挥手](https://static.wangchuang.space/Images/Blogs/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)